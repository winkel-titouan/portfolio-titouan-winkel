---
import Layout from '../../layouts/Layout.astro';
import SkewButton from '../../components/SkewButton.astro';
import { pb } from '../../utils/pb';
import line1 from '../../assets/boutons/line1.svg';
import line2 from '../../assets/boutons/line2.svg';
import bubble from '../../assets/bubble.svg';
import arrowDown from '../../assets/arrow-down.svg';
import lineTop from '../../assets/card/line-top.svg';
import lineBot from '../../assets/card/line-bot.svg';
import javascriptLogo from '../../assets/logos/js.svg';
import astroLogo from '../../assets/logos/astrojs.svg';
import tailwindLogo from '../../assets/logos/tailwindcss.svg';
import sqlLogo from '../../assets/logos/sql.svg';
import pocketbaseLogo from '../../assets/logos/pocketbase.svg';
import capcutLogo from '../../assets/logos/capcut.svg';
import cssLogo from '../../assets/logos/css.svg';
import htmlLogo from '../../assets/logos/html.svg';
import figmaLogo from '../../assets/logos/figma.svg';

let projets = [];
let errorMessage = '';

try {
  console.log('[v0] Fetching projects from PocketBase...');
  const records = await pb.collection('projets').getFullList({
    sort: '-created',
  });
  console.log('[v0] Projects fetched:', records.length, 'projects');
  console.log('[v0] First project:', records[0]);
  projets = records;
} catch (error) {
  errorMessage = `Erreur: ${error.message}`;
  console.error('[v0] Erreur lors de la récupération des projets:', error);
}

console.log('[v0] Projets array length:', projets.length);

function getImageUrl(projet) {
  if (projet.prod_finale && projet.prod_finale.length > 0) {
    return `https://portfolio.titouan-winkel.fr/api/files/projets/${projet.id}/${projet.prod_finale[0]}`;
  }
  return '/placeholder.svg?height=400&width=300';
}
---

<Layout title="Mes Projets - Titouan Winkel">
  <main class="min-h-screen pt-32 pb-20">
    <!-- Centered title section with single bubble -->
    <section class="relative max-w-7xl mx-auto px-4 md:px-8 mb-16 md:mb-52">
      <!-- Single bubble behind title -->
      <div class="absolute top-14 left-2/5 -translate-y-1/2 -translate-x-1/2 z-0 hidden md:block">
        <img src={bubble.src || "/placeholder.svg"} alt="" class="w-48 h-48 opacity-60" />
      </div>

      <!-- Made title responsive with smaller text on mobile -->
      <div class="relative z-40 flex justify-center md:z-60">
        <div class="relative inline-block">
          <img src={line1.src || "/placeholder.svg"} alt="" class="absolute -top-2 -left-8 w-8 h-8 md:w-12 md:h-12" />
          <h1 class="text-black font-[Russo_One] text-3xl md:text-[50px] font-normal leading-normal">
            Mes projets
          </h1>
          <img src={line2.src || "/placeholder.svg"} alt="" class="absolute -bottom-2 -right-8 w-8 h-8 md:w-12 md:h-12" />
        </div>
      </div>
    </section>

    <!-- Simplified search section without competence filters -->
    <section class="max-w-7xl mx-auto px-4 md:px-8 mb-12 space-y-6">
      <!-- Sort filter -->
      <div class="flex justify-center items-center gap-4">
        <span class="text-black font-[Space_Grotesk] text-lg font-medium">Trier par :</span>
        <select
          id="sortSelect"
          class="px-4 py-3 border-3 border-black font-[Space_Grotesk] text-base bg-white focus:outline-none focus:ring-2 focus:ring-black"
        >
          <option value="recent">Du plus récent au plus ancien</option>
          <option value="ancien">Du plus ancien au plus récent</option>
        </select>
      </div>

      <!-- Results counter -->
      <p class="text-center text-black font-[Space_Grotesk] text-lg">
        <span id="resultCount">{projets.length}</span> projet(s)
      </p>
    </section>

    <!-- Display error message if projects failed to load -->
    {errorMessage && (
      <div class="max-w-7xl mx-auto px-4 md:px-8 mb-8">
        <p class="text-red-600 text-center font-[Space_Grotesk]">{errorMessage}</p>
      </div>
    )}

    <!-- Simplified project cards without competences -->
    <section class="max-w-7xl mx-auto px-4 md:px-20" id="projectsList">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-20">
        {projets.map((projet) => (
          <article 
            class="project-item relative p-6 flex flex-col items-center text-center space-y-4 transition-all duration-300 hover:scale-105 hover:shadow-2xl cursor-pointer"
            data-name={projet.nom_projet.toLowerCase()}
            data-created={projet.created}
            style="background: linear-gradient(353deg, rgba(234, 221, 255, 0.23) 10.66%, #A983E2 67.17%, rgba(234, 221, 255, 0.23) 109.64%);"
            onclick={`window.location.href='/projets/${projet.id}'`}
          >
            <!-- Added corner decorations -->
            <img 
              src={lineTop.src || "/placeholder.svg"} 
              alt="" 
              class="absolute -top-1 -left-3 w-7 h-7" 
            />
            <img 
              src={lineBot.src || "/placeholder.svg"} 
              alt="" 
              class="absolute -bottom-5 -right-3 w-7 h-7" 
            />

            <!-- Project image -->
            <div class="w-full flex justify-center items-center min-h-[200px]">
              <img 
                src={getImageUrl(projet) || "/placeholder.svg"} 
                alt={projet.nom_projet}
                class="max-w-full h-auto max-h-[250px] object-contain"
              />
            </div>

            <!-- Project title -->
            <h2 class="text-black font-[Russo_One] text-2xl font-normal">
              {projet.nom_projet}
            </h2>

            <!-- Project description -->
            <p class="text-black font-[Space_Grotesk] text-base leading-relaxed flex-grow">
              {projet.description}
            </p>

            
          </article>
        ))}
      </div>
    </section>
  </main>
</Layout>

<!-- Simplified filtering without competences -->
<script>
  const sortSelect = document.getElementById('sortSelect') as HTMLSelectElement;
  const projectsList = document.getElementById('projectsList')?.querySelector('.grid');

  function sortProjects() {
    if (!projectsList) return;

    const projectItems = Array.from(projectsList.children) as HTMLElement[];
    const sortValue = sortSelect.value;

    // Get the created dates from data attributes
    projectItems.sort((a, b) => {
      const dateA = new Date(a.getAttribute('data-created') || '').getTime();
      const dateB = new Date(b.getAttribute('data-created') || '').getTime();

      if (sortValue === 'recent') {
        return dateB - dateA; // Most recent first
      } else {
        return dateA - dateB; // Oldest first
      }
    });

    // Re-append in sorted order
    projectItems.forEach(item => projectsList.appendChild(item));
  }

  sortSelect?.addEventListener('change', sortProjects);
</script>
