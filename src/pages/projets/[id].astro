---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import SkewButton from "../../components/SkewButton.astro";
import SectionTitle from "../../components/SectionTitle.astro";
import { pb } from "../../utils/pb";
import bubble from "../../assets/bubble.svg";
import line1 from "../../assets/boutons/line1.svg";
import line2 from "../../assets/boutons/line2.svg";
import javascriptLogo from "../../assets/logos/js.svg";
import astroLogo from "../../assets/logos/astrojs.svg";
import tailwindLogo from "../../assets/logos/tailwindcss.svg";
import sqlLogo from "../../assets/logos/sql.svg";
import pocketbaseLogo from "../../assets/logos/pocketbase.svg";
import capcutLogo from "../../assets/logos/capcut.svg";
import cssLogo from "../../assets/logos/css.svg";
import htmlLogo from "../../assets/logos/html.svg";
import figmaLogo from "../../assets/logos/figma.svg";

export async function getStaticPaths() {
    const projects = await pb.collection("projets").getFullList();

    return projects.map((project) => ({
        params: { id: project.id },
        props: { project },
    }));
}

const { project } = Astro.props;

const logoMap: Record<string, any> = {
    javascript: javascriptLogo,
    astro: astroLogo,
    tailwind: tailwindLogo,
    sql: sqlLogo,
    pocketbase: pocketbaseLogo,
    capcut: capcutLogo,
    css: cssLogo,
    html: htmlLogo,
    figma: figmaLogo,
};

// Helper function to get image URL from PocketBase
function getImageUrl(record: any, filename: string) {
    return `https://portfolio.titouan-winkel.fr/api/files/${record.collectionId}/${record.id}/${filename}`;
}

// Get the first image from prod_finale array
const heroImageUrl = project.logo_new
    ? getImageUrl(project, project.logo_new)
    : "";

// Get inspirations images
const inspirationImages = project.inspirations || [];

// Get production finale images
const prodFinaleImages = project.prod_finale || [];

// Get logo images
const logoOldUrl = project.logo_old
    ? getImageUrl(project, project.logo_old)
    : "";
const logoNewUrl = project.logo_new
    ? getImageUrl(project, project.logo_new)
    : "";

const introText = project.introduction || "";
const introWords = introText.split(" ");
const halfLength = Math.ceil(introWords.length / 2);
const introCol1 = introWords.slice(0, halfLength).join(" ");
const introCol2 = introWords.slice(halfLength).join(" ");

const inspText = project.inspiration_texte || "";
const inspParagraphs = inspText
    .split(". ")
    .reduce((acc: string[], sentence: string, index: number) => {
        const paragraphIndex = Math.floor(index / 3);
        if (!acc[paragraphIndex]) acc[paragraphIndex] = "";
        acc[paragraphIndex] +=
            sentence + (index < inspText.split(". ").length - 1 ? ". " : "");
        return acc;
    }, [])
    .filter((p) => p.trim());
---

<Layout title={project.nom_projet}>
    <!-- Hero Section with project title and colored background -->
    <!-- Added negative z-index to position hero behind header -->
    <section
        class="relative py-32 overflow-hidden -mt-32 pt-48 -z-10"
        style={`background-color: ${project.couleur};`}
    >
        <div class="max-w-7xl mx-auto px-8 relative z-10">
            <div class="flex items-center justify-center gap-8">
                {
                    heroImageUrl && (
                        <img
                            src={heroImageUrl || "/placeholder.svg"}
                            alt={`${project.nom_projet} logo`}
                            class="w-24 h-54 object-contain"
                        />
                    )
                }
                <h1
                    class="text-black font-['Russo_One'] text-[50px] font-normal leading-normal"
                >
                    {project.nom_projet}
                </h1>
            </div>
        </div>
    </section>

    <!-- Skills Section with logos -->
    <section class="py-12 bg-white">
        <div class="max-w-7xl mx-auto px-8">
            <SectionTitle text="Compétences mobilisées" />

            <div class="flex gap-8 justify-start mt-8">
                {
                    project.competences &&
                        project.competences.map((competence: string) => (
                            <div class="relative">
                                {/* Line decorations in corners with smaller size */}
                                <img
                                    src={line1.src || "/placeholder.svg"}
                                    alt=""
                                    class="absolute z-30"
                                    style="width: 25px; top: -6px; left: 0px;"
                                />
                                <img
                                    src={line2.src || "/placeholder.svg"}
                                    alt=""
                                    class="absolute z-30"
                                    style="width: 25px; bottom: -6px; right: 0px;"
                                />

                                {/* Skewed background using project color with black border */}
                                <div
                                    class="absolute inset-0 z-0 transform skew-x-[-15deg] border-4 border-black"
                                    style={`background-color: ${project.couleur};`}
                                />
                                {/* Logo container */}
                                <div class="relative z-10 px-6 py-4">
                                    <img
                                        src={
                                            logoMap[competence]?.src ||
                                            "/placeholder.svg" ||
                                            "/placeholder.svg"
                                        }
                                        alt={competence}
                                        class="w-16 h-16 object-contain"
                                    />
                                </div>
                            </div>
                        ))
                }
            </div>
        </div>
    </section>

    <!-- Introduction Section -->
    <section class="py-16 bg-white">
        <div class="max-w-7xl mx-auto px-8">
            <SectionTitle text="Introduction" />

            <div class="grid grid-cols-2 gap-16">
                <p
                    class="text-black font-['Space_Grotesk'] text-[20px] font-normal leading-relaxed"
                    style="text-align: justify;"
                >
                    {introCol1}
                </p>
                <p
                    class="text-black font-['Space_Grotesk'] text-[20px] font-normal leading-relaxed"
                    style="text-align: justify;"
                >
                    {introCol2}
                </p>
            </div>
        </div>
    </section>

    <!-- Inspirations Section -->
    {
        project.inspiration_texte && (
            <section class="py-16 bg-white">
                <div class="max-w-7xl mx-auto px-8">
                    <SectionTitle text="Inspirations" />

                    <div class="flex gap-16 items-center">
                        {/* Text content - left side, reduced to 1/2 width */}
                        <div class="w-1/2 space-y-6">
                            {inspParagraphs.map((paragraph: string) => (
                                <p
                                    class="text-black font-['Space_Grotesk'] text-[20px] font-normal leading-relaxed"
                                    style="text-align: justify;"
                                >
                                    {paragraph}
                                </p>
                            ))}
                        </div>

                        {/* Images - right side, 3 images horizontally in 290px total */}
                        <div class="flex gap-2 max-w-[290px]">
                            {inspirationImages
                                .slice(0, 3)
                                .map((image: string) => (
                                    <img
                                        src={
                                            getImageUrl(project, image) ||
                                            "/placeholder.svg" ||
                                            "/placeholder.svg"
                                        }
                                        alt="Inspiration"
                                        class="w-[200px] h-[250px] object-cover rounded"
                                    />
                                ))}
                        </div>
                    </div>
                </div>
            </section>
        )
    }

    <!-- Logo Evolution Section -->
    {
        (project.logo_old || project.logo_new) && (
            <section class="py-16 bg-white">
                <div class="max-w-7xl mx-auto px-8">
                    <SectionTitle text="Logo" />

                    <div class="flex items-center justify-center gap-16 mb-12">
                        {/* Old Logo */}
                        {project.logo_old && (
                            <div class="flex flex-col items-center">
                                <img
                                    src={logoOldUrl || "/placeholder.svg"}
                                    alt="Ancien logo"
                                    class="w-48 h-48 object-contain mb-6"
                                />
                                <p class="text-black font-['Space_Grotesk'] text-[20px] font-normal text-center max-w-xs leading-relaxed">
                                    {project.logo_old_txt}
                                </p>
                            </div>
                        )}

                        {/* Arrow - replaced with custom SVG using project color */}
                        {project.logo_old && project.logo_new && (
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="120"
                                height="41"
                                viewBox="0 0 120 41"
                                fill="none"
                            >
                                <path
                                    d="M120 20.207L85 -0.000228882V40.4143L120 20.207ZM0 20.207L0 23.707L88.5 23.707V20.207V16.707L0 16.707L0 20.207Z"
                                    fill={project.couleur}
                                />
                            </svg>
                        )}

                        {/* New Logo */}
                        {project.logo_new && (
                            <div class="flex flex-col items-center">
                                <img
                                    src={logoNewUrl || "/placeholder.svg"}
                                    alt="Nouveau logo"
                                    class="w-48 h-48 object-contain mb-6"
                                />
                                <p class="text-black font-['Space_Grotesk'] text-[20px] font-normal text-center max-w-xs leading-relaxed">
                                    {project.logo_new_txt}
                                </p>
                            </div>
                        )}
                    </div>
                </div>
            </section>
        )
    }

    <!-- Production Finale Section -->
    {
        prodFinaleImages.length > 0 && (
            <section class="py-16 bg-white">
                <div class="max-w-7xl mx-auto px-8">
                    <SectionTitle text="Production Finale" />

                    <div class="grid grid-cols-4 gap-8 mb-12">
                        {prodFinaleImages.map((image: string) => (
                            <img
                                src={
                                    getImageUrl(project, image) ||
                                    "/placeholder.svg" ||
                                    "/placeholder.svg"
                                }
                                alt="Production finale"
                                class="w-full h-[400px] object-contain"
                            />
                        ))}
                    </div>

                    {/* Visit Website Button */}
                    <div class="flex justify-start">
                        <SkewButton href={project.lien_appli || "#"}>
                            Accéder au site web
                        </SkewButton>
                    </div>
                </div>
            </section>
        )
    }
</Layout>
